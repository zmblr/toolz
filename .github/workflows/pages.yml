name: Deploy Package Search
on:
  push:
    branches: [main, unstable, release-*]
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *" # Daily at 6 AM UTC
permissions:
  contents: read
  pages: write
  id-token: write
concurrency:
  group: pages
  cancel-in-progress: true
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            accept-flake-config = true
      - name: Build website with multi-branch data
        run: |
          BRANCHES="unstable release-25.11"

          # Build base website from main branch
          nix build .#website --out-link result
          mkdir -p deploy
          cp -rL result/* deploy/

          # Collect package data from each branch
          for branch in $BRANCHES; do
            echo "=== Generating data for $branch ==="

            git fetch origin "$branch" || continue
            git checkout "origin/$branch" || continue

            mkdir -p "deploy/data/$branch"

            # Build website for this branch and extract packages.json
            nix build .#website --out-link "result-$branch" || continue
            cp -L "result-$branch/data/$branch/packages.json" "deploy/data/$branch/packages.json" || echo "No packages.json for $branch"
          done

          # Return to main for final checks
          git checkout -
      - name: Setup Pages
        uses: actions/configure-pages@v4
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: deploy
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
